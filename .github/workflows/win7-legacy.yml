name: Win7 Legacy Build

on:
  workflow_dispatch:
  push:
    branches:
      - win7-legacy
    paths-ignore:
      - '**.md'
      - '**.txt'
      - '.github/**'
      - '!.github/workflows/win7-legacy.yml'

permissions: write-all

env:
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: short

concurrency:
  group: "${{ github.workflow }} - ${{ github.head_ref || github.ref }}"
  cancel-in-progress: true

jobs:
  build-win7:
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Rust Stable
        uses: dtolnay/rust-toolchain@stable

      - name: Add Rust Target
        run: rustup target add x86_64-pc-windows-msvc

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          cache-all-crates: true
          cache-on-failure: true

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Pnpm install and check
        run: |
          pnpm i
          pnpm check x86_64-pc-windows-msvc
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Version
        run: |
          echo "VERSION=$(cat package.json | jq -r '.version')" >> $env:GITHUB_ENV

      - name: Verify VxKex and Resources
        run: |
          Write-Host "éªŒè¯ VxKex å®‰è£…ç¨‹åº..."
          $vxkexPath = ".\src-tauri\vxkex\KexSetup.exe"

          # éªŒè¯ VxKex æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if (Test-Path $vxkexPath) {
            $fileSize = (Get-Item $vxkexPath).Length
            Write-Host "âœ… VxKex å®‰è£…ç¨‹åºå·²å­˜åœ¨: $fileSize bytes"
          } else {
            Write-Error "âŒ VxKex å®‰è£…ç¨‹åºä¸å­˜åœ¨ï¼Œè¯·ç¡®ä¿å·²æäº¤åˆ°ä»“åº“"
            exit 1
          }

          # éªŒè¯ sysproxy.exe æ˜¯å¦è¢«ä¸‹è½½
          $sysproxyPath = ".\src-tauri\resources\sysproxy.exe"
          if (Test-Path $sysproxyPath) {
            $fileSize = (Get-Item $sysproxyPath).Length
            Write-Host "âœ… sysproxy.exe å·²ä¸‹è½½: $fileSize bytes"
          } else {
            Write-Error "âŒ sysproxy.exe æœªä¸‹è½½"
            exit 1
          }

          # åˆ—å‡º resources ç›®å½•å†…å®¹
          Write-Host "`nğŸ“ resources ç›®å½•å†…å®¹:"
          Get-ChildItem ".\src-tauri\resources" | Format-Table Name, Length

      - name: Download WebView2 Runtime
        run: |
          Write-Host "ä¸‹è½½ WebView2 å›ºå®šè¿è¡Œæ—¶..."
          $webview2Url = "https://github.com/westinyang/WebView2RuntimeArchive/releases/download/109.0.1518.78/Microsoft.WebView2.FixedVersionRuntime.109.0.1518.78.x64.cab"
          $webview2Cab = ".\Microsoft.WebView2.FixedVersionRuntime.109.0.1518.78.x64.cab"

          # ä½¿ç”¨ç®€çŸ­çš„ç›®å½•åé¿å…åµŒå¥—é—®é¢˜
          $targetDir = ".\src-tauri\WebView2Runtime"

          # ä¸‹è½½ WebView2 CAB
          Invoke-WebRequest -Uri $webview2Url -OutFile $webview2Cab

          # æ¸…ç†ç›®æ ‡ç›®å½•
          if (Test-Path $targetDir) {
            Remove-Item -Path $targetDir -Recurse -Force
          }
          New-Item -ItemType Directory -Force -Path $targetDir | Out-Null

          # è§£å‹åˆ°ä¸´æ—¶ç›®å½•
          Write-Host "è§£å‹ WebView2 è¿è¡Œæ—¶..."
          $tempDir = ".\webview2_temp"
          if (Test-Path $tempDir) { Remove-Item -Path $tempDir -Recurse -Force }
          New-Item -ItemType Directory -Force -Path $tempDir | Out-Null
          Expand $webview2Cab -F:* $tempDir

          # æŸ¥æ‰¾ msedgewebview2.exe æ‰€åœ¨ç›®å½•å¹¶å¤åˆ¶å†…å®¹
          Write-Host "æŸ¥æ‰¾å¹¶å¤åˆ¶ WebView2 æ–‡ä»¶..."
          $msedgeExe = Get-ChildItem -Path $tempDir -Recurse -Filter "msedgewebview2.exe" | Select-Object -First 1

          if ($msedgeExe) {
            $sourceDir = $msedgeExe.DirectoryName
            Write-Host "æ‰¾åˆ° WebView2 æ–‡ä»¶ç›®å½•: $sourceDir"

            # å¤åˆ¶å†…å®¹åˆ°ç›®æ ‡ç›®å½•
            Copy-Item -Path "$sourceDir\*" -Destination $targetDir -Recurse -Force
            Write-Host "âœ… WebView2 æ–‡ä»¶å·²å¤åˆ¶åˆ°: $targetDir"
          } else {
            Write-Error "âŒ åœ¨è§£å‹çš„æ–‡ä»¶ä¸­æ‰¾ä¸åˆ° msedgewebview2.exe"
            Get-ChildItem -Path $tempDir -Recurse | Select-Object FullName
            exit 1
          }

          # éªŒè¯
          $verifyExe = Join-Path $targetDir "msedgewebview2.exe"
          if (Test-Path $verifyExe) {
            Write-Host "âœ… éªŒè¯æˆåŠŸï¼šmsedgewebview2.exe ä½äºæ­£ç¡®ä½ç½®"
            Write-Host "ç›®æ ‡ç›®å½•å†…å®¹ (å‰10é¡¹):"
            Get-ChildItem -Path $targetDir | Select-Object -First 10 Name | Format-Table
          } else {
            Write-Error "âŒ éªŒè¯å¤±è´¥ï¼šmsedgewebview2.exe ä¸å­˜åœ¨"
            Get-ChildItem -Path $targetDir -Recurse | Select-Object FullName
            exit 1
          }

          # æ¸…ç†
          Remove-Item $webview2Cab -Force
          Remove-Item $tempDir -Recurse -Force

          Write-Host "âœ… WebView2 è¿è¡Œæ—¶å‡†å¤‡å®Œæˆ"

      - name: Prepare Win7 Configuration
        run: |
          Write-Host "å‡†å¤‡ Win7 æ„å»ºé…ç½®..."

          # å¤åˆ¶ PowerShell é…ç½®è„šæœ¬ï¼ˆç¡®ä¿å­˜åœ¨ï¼‰
          if (-not (Test-Path ".\src-tauri\vxkex\configure-vxkex.ps1")) {
            Write-Error "âŒ é…ç½®è„šæœ¬ä¸å­˜åœ¨: configure-vxkex.ps1"
            exit 1
          }

          # è¿è¡Œ prebuild:win7 è„šæœ¬
          pnpm prebuild:win7

          # éªŒè¯é…ç½®æ–‡ä»¶
          if (Test-Path ".\src-tauri\tauri.windows.conf.json") {
            Write-Host "âœ… Win7 é…ç½®æ–‡ä»¶å·²åˆ›å»º"
            Get-Content ".\src-tauri\tauri.windows.conf.json" | Write-Host
          } else {
            Write-Error "âŒ Win7 é…ç½®æ–‡ä»¶åˆ›å»ºå¤±è´¥"
            exit 1
          }

      - name: Build Win7 Package
        run: |
          Write-Host "å¼€å§‹æ„å»º Clash Verge Win7..."
          pnpm build:win7
        env:
          NODE_OPTIONS: "--max_old_space_size=4096"
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

      - name: Rename Output Files
        run: |
          Write-Host "é‡å‘½åè¾“å‡ºæ–‡ä»¶..."

          $targetDir = ".\src-tauri\target\x86_64-pc-windows-msvc\release\bundle\nsis"

          # é‡å‘½å setup.exe
          $setupFiles = Get-ChildItem "$targetDir\*-setup.exe"
          foreach ($file in $setupFiles) {
            $newName = $file.Name -replace "-setup\.exe$", "_win7-setup.exe"
            $newPath = Join-Path $file.DirectoryName $newName
            Rename-Item $file.FullName $newName
            Write-Host "âœ… é‡å‘½å: $($file.Name) -> $newName"
          }

          # é‡å‘½å setup.exe.sig
          $sigFiles = Get-ChildItem "$targetDir\*-setup.exe.sig"
          foreach ($file in $sigFiles) {
            $newName = $file.Name -replace "-setup\.exe\.sig$", "_win7-setup.exe.sig"
            $newPath = Join-Path $file.DirectoryName $newName
            Rename-Item $file.FullName $newName
            Write-Host "âœ… é‡å‘½å: $($file.Name) -> $newName"
          }

          # é‡å‘½å nsis.zip
          $zipFiles = Get-ChildItem "$targetDir\*.nsis.zip"
          foreach ($file in $zipFiles) {
            $newName = $file.Name -replace "\.nsis\.zip$", "_win7.nsis.zip"
            $newPath = Join-Path $file.DirectoryName $newName
            Rename-Item $file.FullName $newName
            Write-Host "âœ… é‡å‘½å: $($file.Name) -> $newName"
          }

      - name: List Build Artifacts
        run: |
          Write-Host "æ„å»ºäº§ç‰©åˆ—è¡¨:"
          Get-ChildItem ".\src-tauri\target\x86_64-pc-windows-msvc\release\bundle\nsis" | Format-Table Name, Length, LastWriteTime

      - name: Create Release (if tagged)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Clash Verge Win7 ${{ github.ref_name }}"
          body: |
            ## Clash Verge Win7 Legacy Build

            **âš ï¸ Windows 7 ä¸“ç”¨ç‰ˆæœ¬ - åŒ…å« VxKex å…¼å®¹å±‚**

            ### ğŸ“¦ åŒ…å«å†…å®¹
            - âœ… è‡ªåŠ¨å®‰è£…å’Œé…ç½® VxKex
            - âœ… å†…ç½® WebView2 Runtime 109.0.1518.78
            - âœ… Windows 7/8/9/10/11 å®Œæ•´å…¼å®¹æ€§æ”¯æŒ
            - âŒ ä¸åŒ…å«è‡ªåŠ¨æ›´æ–°åŠŸèƒ½

            ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
            - Windows 7 SP1 æˆ–æ›´é«˜ç‰ˆæœ¬
            - 64 ä½ç³»ç»Ÿ (x64)
            - ç®¡ç†å‘˜æƒé™ï¼ˆç”¨äº VxKex é…ç½®ï¼‰

            ### ğŸ“– ä½¿ç”¨è¯´æ˜
            1. ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œå®‰è£…ç¨‹åº
            2. å®‰è£…ç¨‹åºä¼šè‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿç‰ˆæœ¬
            3. Windows 7 ç³»ç»Ÿä¼šè‡ªåŠ¨å®‰è£… VxKex
            4. å®‰è£…å®Œæˆåå³å¯æ­£å¸¸ä½¿ç”¨

            ### ğŸ“š è¯¦ç»†æ–‡æ¡£
            - æŸ¥çœ‹å®‰è£…ç›®å½•ä¸­çš„ `WIN7_README.txt`
            - æŸ¥çœ‹ `WIN7_VXKEX_README.md` è·å–è¯¦ç»†æŠ€æœ¯æ–‡æ¡£

            ### ğŸ”— ç›¸å…³èµ„æº
            - VxKex é¡¹ç›®: https://github.com/i486/VxKex
            - ä¸»é¡¹ç›®: https://github.com/clash-verge-rev/clash-verge-rev

            **æ³¨æ„**: æ­¤ç‰ˆæœ¬ä½¿ç”¨ç‹¬ç«‹çš„äº§å“æ ‡è¯†ç¬¦ï¼Œä¸ä¼šä¸ä¸»ç‰ˆæœ¬å†²çªã€‚
          token: ${{ secrets.GITHUB_TOKEN }}
          files: |
            src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*win7*

      - name: Upload Artifacts (for non-tag builds)
        if: "!startsWith(github.ref, 'refs/tags/v')"
        uses: actions/upload-artifact@v4
        with:
          name: clash-verge-win7-${{ env.VERSION }}
          path: |
            src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*win7*
          retention-days: 7

      - name: Build Summary
        run: |
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "  Clash Verge Win7 æ„å»ºå®Œæˆï¼" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "ğŸ“¦ ç‰ˆæœ¬: ${{ env.VERSION }}" -ForegroundColor Cyan
          Write-Host "ğŸ·ï¸  åˆ†æ”¯: ${{ github.ref_name }}" -ForegroundColor Cyan
          Write-Host "ğŸ”¨ æäº¤: ${{ github.sha }}" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "âœ… VxKex: å·²é›†æˆ" -ForegroundColor Green
          Write-Host "âœ… WebView2: 109.0.1518.78 (å›ºå®šç‰ˆæœ¬)" -ForegroundColor Green
          Write-Host "âœ… ç›®æ ‡å¹³å°: Windows 7/8/9/10/11 x64" -ForegroundColor Green
          Write-Host ""
